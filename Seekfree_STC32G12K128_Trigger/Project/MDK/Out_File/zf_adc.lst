C251 COMPILER V5.60.0,  zf_adc                                                             30/05/25  16:28:24  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE zf_adc
OBJECT MODULE PLACED IN .\Out_File\zf_adc.obj
COMPILER INVOKED BY: E:\Kust-Travel\Keil_v5\C251\BIN\C251.EXE ..\..\Libraries\seekfree_libraries\zf_adc.c LARGE INTR2 FL
                    -OAT64 WARNINGLEVEL(3) OPTIMIZE(0,SPEED) BROWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..
                    -\Libraries\seekfree_peripheral;..\CODE;..\USER\inc;..\USER\src;..\..\Libraries\seekfree_components) DEBUG PRINT(.\Out_Fi
                    -le\zf_adc.lst) OBJECT(.\Out_File\zf_adc.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2           * COPYRIGHT NOTICE
    3           * Copyright (c) 2020,Öð·É¿Æ¼¼
    4           * All rights reserved.
    5           * ¼¼ÊõÌÖÂÛQQÈº£ºÒ»Èº£º179029047(ÒÑÂú)  ¶þÈº£º244861897(ÒÑÂú)  ÈýÈº£º824575535
    6           *
    7           * ÒÔÏÂËùÓÐÄÚÈÝ°æÈ¨¾ùÊôÖð·É¿Æ¼¼ËùÓÐ£¬Î´¾­ÔÊÐí²»µÃÓÃÓÚÉÌÒµÓÃÍ¾£¬
    8           * »¶Ó­¸÷Î»Ê¹ÓÃ²¢´«²¥±¾³ÌÐò£¬ÐÞ¸ÄÄÚÈÝÊ±±ØÐë±£ÁôÖð·É¿Æ¼¼µÄ°æÈ¨ÉùÃ÷¡£
    9           *
   10           * @file                adc
   11           * @company                     ³É¶¼Öð·É¿Æ¼¼ÓÐÏÞ¹«Ë¾
   12           * @author              Öð·É¿Æ¼¼(QQ790875685)
   13           * @version             ²é¿´docÄÚversionÎÄ¼þ °æ±¾ËµÃ÷
   14           * @Software            MDK FOR C251 V5.60
   15           * @Target core         STC32G12K128
   16           * @Taobao              https://seekfree.taobao.com/
   17           * @date                2020-4-14
   18           ********************************************************************************************************
             -************/
   19          
   20          
   21          #include "zf_adc.h"
   22          #include "intrins.h"
   23          #include "SEEKFREE_OLED.h"
   24          
   25          //-------------------------------------------------------------------------------------------------------
             -------------
   26          //  @brief      ADC³õÊ¼»¯
   27          //  @param      adcn            Ñ¡ÔñADCÍ¨µÀ
   28          //  @param      speed                   ADCÊ±ÖÓÆµÂÊ
   29          //  @return     void
   30          //  Sample usage:               adc_init(ADC_P10,ADC_SYSclk_DIV_2);//³õÊ¼»¯P1.0ÎªADC¹¦ÄÜ,ADCÊ±ÖÓÆµÂÊ£ºSYS
             -clk/2
   31          //-------------------------------------------------------------------------------------------------------
             -------------
   32          void adc_init(ADCN_enum adcn,ADC_SPEED_enum speed)
   33          {
   34   1              ADC_CONTR |= 1<<7;                              //1 £º´ò¿ª ADC µçÔ´
   35   1              
   36   1              ADC_CONTR &= (0xF0);                    //Çå³ýADC_CHS[3:0] £º ADC Ä£ÄâÍ¨µÀÑ¡ÔñÎ»
   37   1              ADC_CONTR |= adcn;
   38   1              
   39   1              if((adcn >> 3) == 1) //P0.0
   40   1              {
   41   2                      //IO¿ÚÐèÒªÉèÖÃÎª¸ß×èÊäÈë
   42   2                      P0M0 &= ~(1 << (adcn & 0x07));
   43   2                      P0M1 |= (1 << (adcn & 0x07));
   44   2              }
   45   1              else if((adcn >> 3) == 0) //P1.0        
   46   1              {
   47   2                      //IO¿ÚÐèÒªÉèÖÃÎª¸ß×èÊäÈë
   48   2                      P1M0 &= ~(1 << (adcn & 0x07));
   49   2                  P1M1 |= (1 << (adcn & 0x07));
   50   2              }
   51   1      
C251 COMPILER V5.60.0,  zf_adc                                                             30/05/25  16:28:24  PAGE 2   

   52   1              ADCCFG |= speed&0x0F;                   //ADCÊ±ÖÓÆµÂÊSYSclk/2/speed&0x0F;
   53   1              
   54   1              ADCCFG |= 1<<5;                                 //×ª»»½á¹ûÓÒ¶ÔÆë¡£ ADC_RES ±£´æ½á¹ûµÄ¸ß 2 Î»£¬ ADC_RESL ±£´æ½á¹ûµÄµÍ 8 Î»¡£
   55   1      }
   56          
   57          
   58          
   59          //-------------------------------------------------------------------------------------------------------
             -------------
   60          //  @brief      ADC×ª»»Ò»´Î
   61          //  @param      adcn            Ñ¡ÔñADCÍ¨µÀ
   62          //  @param      resolution      ·Ö±æÂÊ
   63          //  @return     void
   64          //  Sample usage:               adc_convert(ADC_P10, ADC_10BIT);
   65          //-------------------------------------------------------------------------------------------------------
             -------------
   66          uint16 adc_once(ADCN_enum adcn,ADCRES_enum resolution)
   67          {
   68   1              uint16 adc_value;
   69   1              static uint16 last_adc_value=0;
   70   1              uint16 count=0;
   71   1              bit time_out;
   72   1              ADC_CONTR &= (0xF0);                    //Çå³ýADC_CHS[3:0] £º ADC Ä£ÄâÍ¨µÀÑ¡ÔñÎ»
   73   1              ADC_CONTR |= adcn;
   74   1              
   75   1              ADC_CONTR |= 0x40;                      // Æô¶¯ AD ×ª»»
   76   1              while (!(ADC_CONTR & 0x20) )    // ²éÑ¯ ADC Íê³É±êÖ¾
   77   1              {
   78   2                      if(++count >= 500) ADC_CONTR |= 0x20,time_out=1;
   79   2              }
   80   1              ADC_CONTR &= ~0x20;                     // ÇåÍê³É±êÖ¾
   81   1              
   82   1              if(time_out)
   83   1              {
   84   2                      time_out=0;
   85   2                      //³¬Ê±£¬×ª»»Ê§°Ü£¬·µ»ØÉÏ´ÎadcÖµ,·ÀÖ¹¿¨ËÀ
   86   2                      ADC_RES = 0;
   87   2                      ADC_RESL = 0;
   88   2                      return last_adc_value;
   89   2              }
   90   1              
   91   1              adc_value = ADC_RES;                    //´æ´¢ ADC µÄ 12 Î»½á¹ûµÄ¸ß 4 Î»
   92   1              adc_value <<= 8;
   93   1              adc_value |= ADC_RESL;                  //´æ´¢ ADC µÄ 12 Î»½á¹ûµÄµÍ 8 Î»
   94   1              
   95   1              ADC_RES = 0;
   96   1              ADC_RESL = 0;
   97   1              
   98   1              adc_value >>= resolution;               //È¡¶àÉÙÎ»
   99   1              last_adc_value = adc_value;
  100   1      
  101   1              return adc_value;
  102   1      }
  103          
  104          //-------------------------------------------------------------------------------------------------------
             -------------
  105          //  @brief     ADC³õÊ¼»¯
  106          //  @param      adcn            Ñ¡ÔñADCÍ¨µÀ
  107          //  @param      resolution      ·Ö±æÂÊ
  108          //  @return     void
  109          //  Sample usage:               adc_convert(ADC_P10, ADC_10BIT);
  110          //-------------------------------------------------------------------------------------------------------
             -------------
  111          void adc_init_5(ADC_SPEED_enum resolution)
  112          {
  113   1              adc_init(ADC_P10, resolution);//×óÊú
C251 COMPILER V5.60.0,  zf_adc                                                             30/05/25  16:28:24  PAGE 3   

  114   1              adc_init(ADC_P17, resolution);//×óÊú
  115   1              adc_init(ADC_P03, resolution);//ÖÐ
  116   1              adc_init(ADC_P01, resolution);//ÓÒ´¹
  117   1              adc_init(ADC_P02, resolution);//ÓÒÊú
  118   1      }
  119          //-------------------------------------------------------------------------------------------------------
             -------------
  120          //  @brief      ADC²É¼¯N´Î
  121          //  @param      adcn            Ñ¡ÔñADCÍ¨µÀ
  122          //  @param      resolution      ·Ö±æÂÊ
  123          //  @return     void
  124          //  Sample usage:               adc_convert(ADC_P10, ADC_10BIT);
  125          //»ñÈ¡10´ÎADC1²ÉÑùÖµÖÐÖµÆ½¾ùÂË²¨·¨
  126          //-------------------------------------------------------------------------------------------------------
             -------------
  127          uint16 ADC_Median_Average(ADCN_enum adcn)
  128          {
  129   1        uint16 data1,data2,data3,tmp,sum=0;
  130   1        uint16 temp_val=0;
  131   1        uint8 delay,num;
  132   1      
  133   1        for(num=0;num<10;num++)
  134   1        {
  135   2           data1 = adc_once(adcn,ADC_12BIT);
  136   2             for(delay=0;delay<10;delay++);
  137   2           data2 = adc_once(adcn,ADC_12BIT);
  138   2             for(delay=0;delay<10;delay++);
  139   2           data3 = adc_once(adcn,ADC_12BIT);
  140   2              //2.È¡ÖÐÖµ
  141   2              if (data1 > data3)
  142   2              {
  143   3                tmp = data1; data1 = data2; data2 = tmp;
  144   3               }
  145   2               if (data3 > data2)
  146   2                 tmp = data2;
  147   2               else if(data3 > data1)
  148   2                 tmp = data3;
  149   2               else
  150   2                 tmp = data1;
  151   2               sum+=tmp;
  152   2      
  153   2          }
  154   1          temp_val=sum/10;
  155   1      
  156   1         return temp_val;
  157   1      }
  158          
  159          /*************************************************************************
  160          *  º¯ÊýÃû³Æ£ºvoid ADC_Voltage(void)
  161          *  ¹¦ÄÜËµÃ÷£ºµçÑ¹²âÁ¿²âÊÔ³ÌÐò
  162          *  ²ÎÊýËµÃ÷£ºÎÞ
  163          *  º¯Êý·µ»Ø£ºÎÞ
  164          *  ÐÞ¸ÄÊ±¼ä£º2020Äê3ÔÂ10ÈÕ
  165          *  ±¸    ×¢£ºP00½Å²âÁ¿µçÑ¹
  166          *************************************************************************/
  167          uint16 ADC_Voltage(void)
  168          {
  169   1              uint16 ad_result = 0;           //Òý½ÅµçÑ¹
  170   1              uint16 battery_voltage = 0;     //µç³ØµçÑ¹
  171   1              uint32 temp=0;
  172   1              uint8 delay;
  173   1      
  174   1              ad_result = adc_once(ADC_P00, ADC_12BIT);//²»ÄÜ×÷¹ý¶à´¦Àí£¬ÂË²¨Ëã·¨¾¡Á¿¼òµ¥£¬ÒòÎªËã²»Íê±»´ò¶Ï»áµ¼ÖÂ³ÌÐò¿
             -¨ËÀ
  175   1              for(delay=0;delay<10;delay++);
  176   1              temp = (((uint32)ad_result * 3300) / 4096);  //¼ÆËã³öµ±Ç°adcÒý½ÅµÄµçÑ¹ ¼ÆËã¹«Ê½Îª ad_result*VCC/ADC·Ö±æÂ
C251 COMPILER V5.60.0,  zf_adc                                                             30/05/25  16:28:24  PAGE 4   

             -Ê    VCCµ¥Î»Îªmv
  177   1              battery_voltage =  temp * 5.5;//¸ù¾ÝÒý½ÅµçÑ¹  ºÍ·ÖÑ¹µç×èµÄ×èÖµ¼ÆËãµç³ØµçÑ¹ ¼ÆËã¹«Ë¾Îª   Òý½ÅµçÑ¹*(R2+R3)
             -/R3   R3Îª½ÓµØ¶Ëµç×è   
  178   1                      
  179   1              return battery_voltage;
  180   1      }
  181          
  182          
  183          
  184          
  185          
  186          
  187          
  188          
  189          
  190          
  191          
  192          
  193          
  194          
  195          
  196          
  197          
  198          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       934     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =        41     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =         1     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =         7     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
